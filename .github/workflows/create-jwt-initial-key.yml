name: JWT Key Initialization Job

on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Spring profile to use'
        required: false
        default: 'local-was'
        type: choice
        options:
          - local-was
          - local
          - dev

jobs:
  jwt-key-init:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Run JWT Key Initialization Job
        env:
          MONGODB_CONNECTION_URI: ${{ secrets.MONGODB_CONNECTION_URI }}
          MYSQL_JDBC_URL: ${{ secrets.MYSQL_JDBC_URL }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_SCHEMA: ${{ secrets.MYSQL_SCHEMA }}
          MYSQL_USERNAME: ${{ secrets.MYSQL_USERNAME }}
        run: |
          TIMESTAMP=$(date +"%Y-%m-%dT%H:%M:%S.%N")
          PROFILE="${{ github.event.inputs.profile || 'local-was' }}"

          echo "=========================================="
          echo "JWT Key Initialization Batch Job"
          echo "=========================================="
          echo ""
          echo "Active Profile: ${PROFILE}"
          echo "Timestamp: ${TIMESTAMP}"
          echo ""
          echo "Starting jwtKeyInitJob..."
          echo ""

          ./gradlew :dailyfeed-batch:bootRun --args="\
          --spring.profiles.active=${PROFILE} \
          --spring.batch.job.name=jwtKeyInitJob \
          --spring.task.scheduling.enabled=false \
          --spring.main.web-application-type=none \
          requestedAt=${TIMESTAMP}"

      - name: Job Status
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "JWT Key Initialization Job Completed Successfully!"
          echo "=========================================="

      - name: Job Failed
        if: failure()
        run: |
          echo ""
          echo "=========================================="
          echo "JWT Key Initialization Job Failed!"
          echo "=========================================="
          exit 1